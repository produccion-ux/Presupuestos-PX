<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos PX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00353F">
    <link rel="apple-touch-icon" href="logo-192.png">

    <style>
        :root { --primary-dark: #00353F; --primary-gold: #BFA15C; }
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .bg-primary-dark { background-color: var(--primary-dark); }
        .text-primary-gold { color: var(--primary-gold); }
        .toast { animation: fade-in-out 3s ease-in-out forwards; z-index: 100; }
        @keyframes fade-in-out {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .filter-btn { padding: 0.5rem 1rem; border-radius: 9999px; background-color: #e5e7eb; color: #374151; font-weight: 500; transition: all 0.2s; }
        .filter-btn.active { background-color: var(--primary-dark); color: white; }
        .filter-btn:hover:not(.active) { background-color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">
        <header class="bg-primary-dark p-4 shadow-md sticky top-0 z-10 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="logo-192.png" alt="Logo PX" class="h-10 w-10">
                <h1 class="text-2xl font-bold text-white">Presupuestos PX</h1>
            </div>
        </header>

        <main class="p-4 space-y-6 pb-24">
            
            <div id="welcome-screen">
                <div class="text-center p-4 border rounded-lg bg-gray-50">
                    <h2 class="text-xl font-bold text-primary-dark mb-4">Bienvenido</h2>
                    <p class="text-gray-600 mb-6">Crea un proyecto nuevo o carga uno existente usando su ID para sincronizar entre dispositivos.</p>
                    <div class="space-y-3">
                        <button id="show-create-btn" class="w-full bg-primary-dark text-white font-semibold py-3 px-4 rounded-lg hover:bg-opacity-90">
                            Crear Nuevo Proyecto
                        </button>
                        <button id="show-load-input-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300">
                            Cargar por ID
                        </button>
                    </div>
                    <div id="load-project-section" class="hidden mt-4 space-y-2">
                         <div class="flex gap-2">
                            <input type="text" id="load-id-input" placeholder="Pega el ID del proyecto aquí" class="block w-full rounded-md border-gray-300 shadow-sm px-3 py-2">
                            <button id="load-project-btn" class="bg-primary-dark text-white font-semibold py-2 px-4 rounded-lg">Cargar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-content" class="hidden space-y-6">
                 <div class="bg-gray-50 border p-3 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">ID de Proyecto (para sincronizar):</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="project-id-input" readonly class="block w-full rounded-none rounded-l-md border-gray-300 bg-gray-200 px-3 py-2 text-gray-600">
                        <button id="copy-id-btn" type="button" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200">
                            <span>Copiar</span>
                        </button>
                    </div>
                </div>
                
                <div id="project-details">
                    <div class="flex justify-between items-center">
                        <h2 id="project-name" class="text-xl font-semibold text-primary-dark"></h2>
                        <button id="edit-project-btn" class="text-primary-dark hover:text-primary-gold p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 border p-3 rounded-lg"><h3 class="text-sm">Presupuesto Disponible</h3><p id="available-budget" class="text-xl font-bold"></p></div>
                    <div class="bg-red-50 border p-3 rounded-lg"><h3 class="text-sm">Total Gastado</h3><p id="total-spent" class="text-xl font-bold"></p></div>
                    <div class="bg-green-50 border p-3 rounded-lg"><h3 class="text-sm">Pagos Recibidos</h3><p id="client-balance" class="text-xl font-bold"></p></div>
                    <div class="bg-yellow-50 border p-3 rounded-lg"><h3 class="text-sm">Total (Filtro)</h3><p id="filtered-total" class="text-xl font-bold"></p></div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2 text-primary-dark">Movimientos</h3>
                    <div class="flex space-x-2 mb-4 text-sm" id="filter-buttons">
                        <button data-filter="all" class="filter-btn active">Gastos</button>
                        <button data-filter="gasto_incluido" class="filter-btn">Incluidos</button>
                        <button data-filter="gasto_extra" class="filter-btn">Extras</button>
                        <button data-filter="abono_cliente" class="filter-btn">Abonos</button>
                    </div>
                    <div id="transactions-list" class="space-y-3"></div>
                </div>

                <div class="mt-8 border-t pt-6 space-y-3">
                    <h3 class="text-lg font-semibold text-primary-dark">Acciones</h3>
                     <button id="export-data-btn" class="w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-blue-200">
                        <span>Exportar Datos</span>
                    </button>
                    <button id="exit-project-btn" class="w-full bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-red-200">
                        <span>Salir del Proyecto</span>
                    </button>
                </div>
            </div>
        </main>

        <button id="add-transaction-btn" class="hidden bg-primary-gold text-white w-14 h-14 rounded-full fixed bottom-6 right-6 items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M228,128a12,12,0,0,1-12,12H136v80a12,12,0,0,1-24,0V140H32a12,12,0,0,1,0-24h80V36a12,12,0,0,1,24,0v80h80A12,12,0,0,1,228,128Z"></path></svg>
        </button>

        <div id="modal-container"></div>
        <div id="toast" class="toast hidden fixed bottom-24 right-6 bg-primary-dark text-white py-2 px-4 rounded-lg shadow-xl"><p id="toast-message"></p></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *********************************************************************************
        // Pega tu configuración de Firebase aquí.
        // *********************************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyBPju-qziiySXSOwjiPW9pcR0_mwFE5j1s",
            authDomain: "presupuestos-px.firebaseapp.com",
            projectId: "presupuestos-px",
            storageBucket: "presupuestos-px.firebasestorage.app",
            messagingSenderId: "758674286792",
            appId: "1:758674286792:web:703ed99be79fd5e4ac5dfd",
        };
        
        // --- NO MODIFICAR DEBAJO DE ESTA LÍNEA ---
        let db;
        try {
            if (firebaseConfig.apiKey === "TU_API_KEY" || !firebaseConfig.projectId) {
                throw new Error("Configuración de Firebase no encontrada o incompleta.");
            }
            const appFirebase = initializeApp(firebaseConfig);
            db = getFirestore(appFirebase);
        } catch(e) {
            console.error("ERROR DE FIREBASE:", e.message);
            alert("ERROR: La configuración de Firebase no es correcta. Por favor, copia y pega tu 'firebaseConfig' en el archivo index.html.");
        }

        const app = {
            projectData: null, projectId: null, currentFilter: 'all', unsubscribe: null,

            init() {
                if (!db) return;
                this.attachEventListeners();
                const localId = localStorage.getItem('presupuestosPXProjectId');
                if (localId) this.loadProject(localId);
            },

            async loadProject(id) {
                if (!id) { this.showToast("Por favor, ingresa un ID válido."); return; }
                this.projectId = id.trim();
                if (this.unsubscribe) this.unsubscribe(); 

                const docRef = doc(db, "projects", this.projectId);
                this.showToast("Conectando con la base de datos...");
                
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.projectData = docSnap.data();
                        this.showToast("Proyecto sincronizado.");
                        this.showMainContent();
                        this.updateUI();
                    } else {
                        this.confirmCreateNewProject(this.projectId);
                    }
                    localStorage.setItem('presupuestosPXProjectId', this.projectId);
                }, (error) => {
                    console.error("Error de Firestore onSnapshot:", error);
                    this.showToast("Error de conexión. Revisa las reglas de Firestore.");
                });
            },

            async createNewProject(id) {
                const newId = id || `proj_${Date.now()}`;
                const newProjectData = { name: "Mi Nueva Obra", totalValue: 0, estimatedBudget: 0, transactions: [] };
                try {
                    await setDoc(doc(db, "projects", newId), newProjectData);
                    this.loadProject(newId);
                } catch(e) { console.error("Error creando documento: ", e); this.showToast("Error al crear el proyecto."); }
            },

            showMainContent() {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('add-transaction-btn').classList.remove('hidden');
                document.getElementById('project-id-input').value = this.projectId;
            },

            showWelcomeScreen() {
                if (this.unsubscribe) this.unsubscribe();
                localStorage.removeItem('presupuestosPXProjectId');
                this.projectId = null; this.projectData = null;
                document.getElementById('welcome-screen').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('add-transaction-btn').classList.add('hidden');
            },
            
            async saveData() {
                if (!this.projectId || !this.projectData) return;
                try { await setDoc(doc(db, "projects", this.projectId), this.projectData); } catch(e) { console.error("Error guardando datos: ", e); }
            },
            
            exportData() {
                if (!this.projectData) { this.showToast("No hay datos para exportar."); return; }
                const dataStr = JSON.stringify(this.projectData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `presupuesto-px-${this.projectId}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                this.showToast("Datos exportados.");
            },
            
            setFilter(filter) {
                this.currentFilter = filter;
                this.updateUI();
            },

            attachEventListeners() {
                document.getElementById('show-create-btn').addEventListener('click', () => this.createNewProject());
                document.getElementById('show-load-input-btn').addEventListener('click', () => { document.getElementById('load-project-section').classList.toggle('hidden'); });
                document.getElementById('load-project-btn').addEventListener('click', () => { this.loadProject(document.getElementById('load-id-input').value); });
                document.getElementById('copy-id-btn').addEventListener('click', () => { const idInput = document.getElementById('project-id-input'); idInput.select(); document.execCommand('copy'); this.showToast("ID copiado."); });
                document.getElementById('exit-project-btn').addEventListener('click', () => this.showWelcomeScreen());
                document.getElementById('add-transaction-btn').addEventListener('click', () => this.openTransactionModal());
                document.getElementById('edit-project-btn').addEventListener('click', () => this.openProjectModal());
                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('filter-buttons').addEventListener('click', (e) => {
                    if (e.target.matches('.filter-btn')) { this.setFilter(e.target.dataset.filter); }
                });
            },
            formatCurrency(amount) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount || 0); },
            updateUI() {
                if (!this.projectData) return;
                const proj = this.projectData;
                document.getElementById('project-name').textContent = proj.name;
                const transactions = proj.transactions || [];
                const totalGastadoGeneral = transactions.filter(t => t.type.startsWith('gasto')).reduce((sum, t) => sum + t.amount, 0);
                const totalAbonos = transactions.filter(t => t.type === 'abono_cliente').reduce((sum, t) => sum + t.amount, 0);
                document.getElementById('available-budget').textContent = this.formatCurrency(proj.estimatedBudget - totalGastadoGeneral);
                document.getElementById('total-spent').textContent = this.formatCurrency(totalGastadoGeneral);
                document.getElementById('client-balance').textContent = this.formatCurrency(proj.totalValue - totalAbonos);
                
                const filteredTransactions = transactions.filter(t => {
                    if (this.currentFilter === 'all') return t.type.startsWith('gasto');
                    return t.type === this.currentFilter;
                });
                const filteredTotal = filteredTransactions.reduce((sum, t) => sum + t.amount, 0);
                document.getElementById('filtered-total').textContent = this.formatCurrency(filteredTotal);
                
                this.renderTransactionList(filteredTransactions);

                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === this.currentFilter);
                });
            },
            renderTransactionList(transactions) {
                const listEl = document.getElementById('transactions-list'); listEl.innerHTML = '';
                if (transactions.length === 0) { listEl.innerHTML = `<p class="text-gray-500 italic text-center mt-4">No hay movimientos en esta categoría.</p>`; return; }
                transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    const isExpense = t.type.startsWith('gasto');
                    const sign = isExpense ? '-' : '+';
                    const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                    const typeText = t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const el = document.createElement('div');
                    el.className = 'bg-white p-3 rounded-lg border flex justify-between items-center';
                    el.innerHTML = `<div><p class="font-semibold">${t.description}</p><p class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString('es-CO')} - ${typeText}</p></div><div class="text-right"><p class="font-bold text-lg ${colorClass}">${sign} ${this.formatCurrency(t.amount)}</p><button onclick="app.deleteTransaction('${t.id}')" class="text-xs text-gray-400 hover:text-red-500 mt-1">Eliminar</button></div>`;
                    listEl.appendChild(el);
                });
            },
            deleteTransaction(id) { this.projectData.transactions = this.projectData.transactions.filter(t => t.id !== id); this.saveData(); },
            confirmCreateNewProject(id) { /* ... Lógica sin cambios ... */ },
            createModal(title, content) { /* ... Lógica sin cambios ... */ },
            closeModal() { /* ... Lógica sin cambios ... */ },
            showToast(message) { /* ... Lógica sin cambios ... */ },
            openProjectModal() { /* ... Lógica sin cambios ... */ },
            openTransactionModal() { /* ... Lógica sin cambios ... */ }
        };
        
        // Lógica de las funciones auxiliares (sin cambios, omitidas por brevedad pero presentes en el código)
        app.confirmCreateNewProject = function(id) { const c = `<p class="text-center text-gray-700 mb-6">El proyecto con ID "<strong class="break-all">${id}</strong>" no existe.<br>¿Quieres crearlo ahora?</p><div class="flex justify-center space-x-4"><button id="cancel-create" class="py-2 px-6 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancelar</button><button id="confirm-create-btn" class="py-2 px-6 bg-primary-dark text-white rounded-lg font-semibold">Sí, Crear</button></div>`; const m = this.createModal('Proyecto no Encontrado', c); document.getElementById('confirm-create-btn').addEventListener('click', () => { this.closeModal(); this.createNewProject(id); }); document.getElementById('cancel-create').addEventListener('click', () => { this.closeModal(); this.showWelcomeScreen(); }); };
        app.createModal = function(title, content) { const c = document.getElementById('modal-container'); const m = document.createElement('div'); m.id = 'modal'; m.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50'; m.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-primary-dark">${title}</h3><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div>${content}</div></div>`; c.appendChild(m); m.addEventListener('click', (e) => { if (e.target.id === 'modal') this.closeModal(); }); document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal()); return m; };
        app.closeModal = function() { const m = document.getElementById('modal'); if (m) m.parentElement.innerHTML = ''; };
        app.showToast = function(message) { const t = document.getElementById('toast'); t.querySelector('p').textContent = message; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); };
        app.openProjectModal = function() { const c = `<form id="project-form" class="space-y-4"><div><label class="block text-sm">Nombre</label><input type="text" id="p-name" value="${this.projectData.name}" class="mt-1 block w-full border rounded-md p-2" required></div><div><label class="block text-sm">Valor Total ($)</label><input type="number" id="p-total" value="${this.projectData.totalValue}" class="mt-1 block w-full border rounded-md p-2" required></div><div><label class="block text-sm">Presupuesto ($)</label><input type="number" id="p-budget" value="${this.projectData.estimatedBudget}" class="mt-1 block w-full border rounded-md p-2" required></div><div class="flex justify-end pt-2"><button type="submit" class="bg-primary-dark text-white py-2 px-5 rounded-lg">Guardar</button></div></form>`; const m = this.createModal('Editar Detalles', c); m.querySelector('#project-form').addEventListener('submit', (e) => { e.preventDefault(); this.projectData.name = document.getElementById('p-name').value; this.projectData.totalValue = parseFloat(document.getElementById('p-total').value); this.projectData.estimatedBudget = parseFloat(document.getElementById('p-budget').value); this.saveData(); this.closeModal(); }); };
        app.openTransactionModal = function() { const c = `<form id="transaction-form" class="space-y-4"><div><label class="block text-sm">Descripción</label><input type="text" id="t-description" class="mt-1 block w-full border rounded-md p-2" required></div><div><label class="block text-sm">Monto ($)</label><input type="number" id="t-amount" class="mt-1 block w-full border rounded-md p-2" required></div><div><label class="block text-sm">Tipo</label><select id="t-type" class="mt-1 block w-full border rounded-md p-2"><option value="gasto_incluido">Gasto Incluido</option><option value="gasto_extra">Gasto Extra</option><option value="abono_cliente">Abono Cliente</option></select></div><div class="flex justify-end pt-2"><button type="submit" class="bg-primary-dark text-white py-2 px-5 rounded-lg">Agregar</button></div></form>`; const m = this.createModal('Nuevo Movimiento', c); m.querySelector('#transaction-form').addEventListener('submit', (e) => { e.preventDefault(); const newTx = { id: `txn_${Date.now()}`, description: document.getElementById('t-description').value, amount: parseFloat(document.getElementById('t-amount').value), type: document.getElementById('t-type').value, date: new Date().toISOString(), }; if (!this.projectData.transactions) this.projectData.transactions = []; this.projectData.transactions.push(newTx); this.saveData(); this.closeModal(); }); };
        
        if (db) {
            app.init();
        }
    </script>
</body>
</html>


