<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos PX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#00353F">
    <link rel="apple-touch-icon" href="./logo-192.png">

    <style>
        :root {
            --primary-dark: #00353F;
            --primary-gold: #BFA15C;
        }
        .bg-primary-dark { background-color: var(--primary-dark); }
        .text-primary-gold { color: var(--primary-gold); }
        .border-primary-gold { border-color: var(--primary-gold); }
        .ring-primary-gold { --tw-ring-color: var(--primary-gold); }
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .toast {
            animation: fade-in-out 3s ease-in-out forwards;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        /* Filter button styles */
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb;
            color: #4b5563;
        }
        .filter-btn.active {
            background-color: var(--primary-dark);
            color: white;
            border-color: var(--primary-dark);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- App Container -->
    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <header class="bg-primary-dark p-4 shadow-md sticky top-0 z-10 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img id="logo-img" src="./logo-192.png" alt="Logo PX" class="h-10 w-10">
                <h1 class="text-2xl font-bold text-white">Presupuestos PX</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="p-4 space-y-6 pb-24">
            <!-- Project Details -->
            <div id="project-details" class="space-y-2">
                <div class="flex justify-between items-center">
                    <h2 id="project-name" class="text-xl font-semibold text-primary-dark"></h2>
                    <button id="edit-project-btn" class="text-primary-dark hover:text-primary-gold p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-700">Presupuesto Disponible</h3>
                    <p id="available-budget" class="text-xl font-bold text-blue-900"></p>
                </div>
                <div class="bg-red-50 border border-red-200 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-red-700">Total Gastado (General)</h3>
                    <p id="total-spent" class="text-xl font-bold text-red-900"></p>
                </div>
                 <div class="bg-green-50 border border-green-200 p-3 rounded-lg">
                    <h3 class="text-sm font-medium text-green-700">Saldo Cliente</h3>
                    <p id="client-balance" class="text-xl font-bold text-green-900"></p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                    <h3 id="filtered-total-title" class="text-sm font-medium text-yellow-700">Total Gastos (Filtro)</h3>
                    <p id="filtered-total" class="text-xl font-bold text-yellow-900"></p>
                </div>
            </div>

            <!-- Transactions -->
            <div>
                 <h3 class="text-lg font-semibold mb-2 text-primary-dark">Movimientos</h3>
                <!-- Filters -->
                <div class="flex space-x-2 mb-4 text-sm" id="filter-buttons">
                    <button data-filter="all" class="filter-btn active">Todos los Gastos</button>
                    <button data-filter="gasto_incluido" class="filter-btn">Incluidos</button>
                    <button data-filter="gasto_extra" class="filter-btn">Extras</button>
                    <button data-filter="abono_cliente" class="filter-btn">Abonos</button>
                </div>
                <!-- Transactions List -->
                <div id="transactions-list" class="space-y-3">
                    <!-- Transactions will be dynamically inserted here -->
                </div>
            </div>

            <!-- Actions Section -->
            <div class="mt-8 border-t pt-6 space-y-3">
                 <h3 class="text-lg font-semibold text-primary-dark">Acciones del Proyecto</h3>
                 <button id="export-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z"></path></svg>
                    <span>Exportar Datos</span>
                 </button>
                 <button id="reset-btn" class="w-full bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-red-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M224,56a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,56Zm-8,64a8,8,0,0,0-8-8H40a8,8,0,0,0,0,16H208A8,8,0,0,0,216,120Zm-8,64a8,8,0,0,0-8-8H40a8,8,0,0,0,0,16H208A8,8,0,0,0,216,184Z" transform="rotate(45 128 128)"></path></svg>
                     <span>Reiniciar Proyecto</span>
                 </button>
            </div>
        </main>
        
        <!-- FAB to add transaction -->
        <button id="add-transaction-btn" class="bg-primary-gold text-white w-14 h-14 rounded-full fixed bottom-6 right-6 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
        </button>

        <!-- Modals -->
        <div id="modal-container"></div>
        
        <!-- Toast Notification -->
        <div id="toast" class="toast hidden fixed bottom-24 right-6 bg-primary-dark text-white py-2 px-4 rounded-lg shadow-xl">
            <p id="toast-message"></p>
        </div>

    </div>

    <script>
        const app = {
            db: null,
            currentFilter: 'all',

            defaultDB: {
                project: {
                    name: "Nueva Obra",
                    totalValue: 0,
                    estimatedBudget: 0,
                    transactions: []
                }
            },

            init() {
                this.loadData();
                this.updateUI();
                this.registerSW();
                this.attachEventListeners();
            },

            attachEventListeners() {
                document.getElementById('add-transaction-btn').addEventListener('click', () => this.openTransactionModal());
                document.getElementById('edit-project-btn').addEventListener('click', () => this.openProjectModal());
                document.getElementById('export-btn').addEventListener('click', () => this.exportData());
                document.getElementById('reset-btn').addEventListener('click', () => this.confirmReset());

                document.querySelectorAll('.filter-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.setFilter(e.target.dataset.filter);
                    });
                });
            },
            
            setFilter(filter) {
                this.currentFilter = filter;
                this.updateUI();
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount);
            },
            
            updateUI() {
                const proj = this.db.project;
                
                document.getElementById('project-name').textContent = proj.name;

                // --- Global Calculations ---
                const totalGastosIncluidos = proj.transactions.filter(t => t.type === 'gasto_incluido').reduce((sum, t) => sum + t.amount, 0);
                const totalGastosExtras = proj.transactions.filter(t => t.type === 'gasto_extra').reduce((sum, t) => sum + t.amount, 0);
                const totalAbonos = proj.transactions.filter(t => t.type === 'abono_cliente').reduce((sum, t) => sum + t.amount, 0);
                
                const totalGastadoGeneral = totalGastosIncluidos + totalGastosExtras;
                const presupuestoDisponible = proj.estimatedBudget - totalGastadoGeneral;
                const saldoCliente = proj.totalValue - totalAbonos;

                // Update global summary cards
                document.getElementById('available-budget').textContent = this.formatCurrency(presupuestoDisponible);
                document.getElementById('total-spent').textContent = this.formatCurrency(totalGastadoGeneral);
                document.getElementById('client-balance').textContent = this.formatCurrency(saldoCliente);

                // --- Filtered Calculations & Rendering ---
                const filteredTransactions = proj.transactions.filter(t => {
                    if (this.currentFilter === 'all') {
                        // **CHANGE**: Only include expense types
                        return t.type === 'gasto_incluido' || t.type === 'gasto_extra';
                    }
                    return t.type === this.currentFilter;
                });

                const filteredTotal = filteredTransactions.reduce((sum, t) => sum + t.amount, 0);
                const filteredTitleEl = document.getElementById('filtered-total-title');
                
                // Update filtered total card
                switch(this.currentFilter) {
                    case 'gasto_incluido':
                        filteredTitleEl.textContent = 'Total Gastos Incluidos';
                        break;
                    case 'gasto_extra':
                        filteredTitleEl.textContent = 'Total Gastos Extras';
                        break;
                    case 'abono_cliente':
                        filteredTitleEl.textContent = 'Total Abonos';
                        break;
                    default: // "all" case
                        filteredTitleEl.textContent = 'Total de Gastos';
                }
                document.getElementById('filtered-total').textContent = this.formatCurrency(filteredTotal);

                // --- Render transactions list ---
                this.renderTransactionList(filteredTransactions);
                
                // Update filter button active state
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === this.currentFilter);
                });
            },
            
            renderTransactionList(transactions) {
                const listEl = document.getElementById('transactions-list');
                listEl.innerHTML = ''; 

                if (transactions.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 italic text-center mt-4">No hay movimientos que coincidan con el filtro.</p>`;
                    return;
                }

                transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    const isExpense = t.type.startsWith('gasto');
                    const sign = isExpense ? '-' : '+';
                    const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                    const typeText = t.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());

                    const transactionEl = document.createElement('div');
                    transactionEl.className = 'bg-white p-3 rounded-lg border flex justify-between items-center animate-fade-in';
                    transactionEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            ${t.imageUrl ? `<img src="${t.imageUrl}" class="w-12 h-12 rounded-md object-cover cursor-pointer" onclick="app.showImage('${t.imageUrl}')">` : '<div class="w-12 h-12 bg-gray-200 rounded-md flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#9CA3AF" viewBox="0 0 256 256"><path d="M200,32H56A24,24,0,0,0,32,56V200a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V56A24,24,0,0,0,200,32Zm8,168a8,8,0,0,1-8,8H56a8,8,0,0,1-8-8V56a8,8,0,0,1,8-8H200a8,8,0,0,1,8,8ZM112,88a32,32,0,1,1-32,32A32,32,0,0,1,112,88Zm-4.4,55.6L80,184H176l-32.8-54.67a8,8,0,0,0-13.6,0Z"></path></svg></div>'}
                            <div>
                                <p class="font-semibold">${t.description}</p>
                                <p class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString('es-CO')} - ${typeText}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg ${colorClass}">${sign} ${this.formatCurrency(t.amount)}</p>
                             <button onclick="app.deleteTransaction('${t.id}')" class="text-xs text-gray-400 hover:text-red-500 mt-1">Eliminar</button>
                        </div>
                    `;
                    listEl.appendChild(transactionEl);
                });
            },

            saveData() {
                localStorage.setItem('presupuestosPXDB', JSON.stringify(this.db));
                this.showToast('Datos guardados.');
            },

            loadData() {
                const data = localStorage.getItem('presupuestosPXDB');
                if (data) {
                    this.db = JSON.parse(data);
                } else {
                    this.db = JSON.parse(JSON.stringify(this.defaultDB));
                }
            },

            createModal(title, content, options = {}) {
                const modalContainer = document.getElementById('modal-container');
                const modal = document.createElement('div');
                modal.id = 'modal';
                modal.className = 'modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50';
                
                let headerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary-dark">${title}</h3>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>`;

                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
                        ${options.noHeader ? '' : headerHTML}
                        <div>${content}</div>
                    </div>
                `;
                modalContainer.appendChild(modal);

                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);

                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'modal') this.closeModal();
                });
                if (!options.noHeader) {
                    document.getElementById('close-modal-btn').addEventListener('click', () => this.closeModal());
                }
                return modal;
            },
            
            closeModal() {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.remove('opacity-100');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => {
                        if (modal.parentElement) {
                            modal.parentElement.innerHTML = '';
                        }
                    }, 250);
                }
            },
            
            openProjectModal() {
                 const content = `
                    <form id="project-form" class="space-y-4">
                        <div>
                            <label for="p-name" class="block text-sm font-medium text-gray-700">Nombre de la Obra</label>
                            <input type="text" id="p-name" value="${this.db.project.name}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold" required>
                        </div>
                        <div>
                            <label for="p-total" class="block text-sm font-medium text-gray-700">Valor Total ($)</label>
                            <input type="number" id="p-total" value="${this.db.project.totalValue}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold" required>
                        </div>
                        <div>
                            <label for="p-budget" class="block text-sm font-medium text-gray-700">Presupuesto Estimado ($)</label>
                            <input type="number" id="p-budget" value="${this.db.project.estimatedBudget}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold" required>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="bg-primary-dark text-white py-2 px-5 rounded-lg font-semibold hover:bg-opacity-90">Guardar Cambios</button>
                        </div>
                    </form>
                `;
                const modal = this.createModal('Editar Detalles de la Obra', content);
                modal.querySelector('#project-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.db.project.name = document.getElementById('p-name').value;
                    this.db.project.totalValue = parseFloat(document.getElementById('p-total').value);
                    this.db.project.estimatedBudget = parseFloat(document.getElementById('p-budget').value);
                    this.saveData();
                    this.updateUI();
                    this.closeModal();
                });
            },

            openTransactionModal() {
                let imageDataUrl = null;
                const content = `
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="t-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                            <input type="text" id="t-description" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold" required>
                        </div>
                        <div>
                            <label for="t-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                            <input type="number" id="t-amount" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold" required>
                        </div>
                        <div>
                            <label for="t-type" class="block text-sm font-medium text-gray-700">Tipo de Movimiento</label>
                            <select id="t-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-gold focus:border-primary-gold">
                                <option value="gasto_incluido">Gasto Incluido</option>
                                <option value="gasto_extra">Gasto Extra</option>
                                <option value="abono_cliente">Abono del Cliente</option>
                            </select>
                        </div>
                        <div>
                            <label for="t-photo" class="block text-sm font-medium text-gray-700">Adjuntar Foto (Opcional)</label>
                            <input type="file" id="t-photo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            <img id="t-preview" class="hidden mt-2 w-24 h-24 object-cover rounded-md">
                        </div>
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="bg-primary-dark text-white py-2 px-5 rounded-lg font-semibold hover:bg-opacity-90">Agregar</button>
                        </div>
                    </form>
                `;
                const modal = this.createModal('Nuevo Movimiento', content);

                const photoInput = modal.querySelector('#t-photo');
                const previewEl = modal.querySelector('#t-preview');
                photoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imageDataUrl = event.target.result;
                            previewEl.src = imageDataUrl;
                            previewEl.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                modal.querySelector('#transaction-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newTransaction = {
                        id: `txn_${Date.now()}`,
                        description: document.getElementById('t-description').value,
                        amount: parseFloat(document.getElementById('t-amount').value),
                        type: document.getElementById('t-type').value,
                        date: new Date().toISOString(),
                        imageUrl: imageDataUrl
                    };

                    this.db.project.transactions.push(newTransaction);
                    this.saveData();
                    this.updateUI();
                    this.closeModal();
                });
            },
            
            confirmReset() {
                const content = `
                    <p class="text-center text-gray-700 mb-6">¿Estás seguro de que quieres borrar todos los datos del proyecto actual? Esta acción no se puede deshacer.</p>
                    <div class="flex justify-center space-x-4">
                        <button id="cancel-reset" class="py-2 px-6 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancelar</button>
                        <button id="confirm-reset-btn" class="py-2 px-6 bg-red-600 text-white rounded-lg font-semibold">Sí, Reiniciar</button>
                    </div>
                `;
                const modal = this.createModal('Confirmar Reinicio', content, { noHeader: true });
                document.getElementById('confirm-reset-btn').addEventListener('click', () => this.resetProject());
                document.getElementById('cancel-reset').addEventListener('click', () => this.closeModal());
            },

            resetProject() {
                this.db = JSON.parse(JSON.stringify(this.defaultDB));
                this.currentFilter = 'all';
                this.saveData();
                this.updateUI();
                this.closeModal();
                this.showToast('Proyecto reiniciado.');
            },
            
            exportData() {
                try {
                    const dataStr = JSON.stringify(this.db, null, 2);
                    const dataBlob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.download = `presupuesto_px_${new Date().toISOString().slice(0,10)}.json`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    this.showToast('Datos exportados.');
                } catch (error) {
                    console.error("Error exporting data:", error);
                    this.showToast('Error al exportar.');
                }
            },
            
            deleteTransaction(id) {
                // Simplified confirmation
                this.db.project.transactions = this.db.project.transactions.filter(t => t.id !== id);
                this.saveData();
                this.updateUI();
                this.showToast('Movimiento eliminado.');
            },

            showImage(imageUrl) {
                const content = `<img src="${imageUrl}" class="w-full h-auto rounded-lg">`;
                this.createModal('Vista Previa', content);
            },

            showToast(message) {
                const toastEl = document.getElementById('toast');
                const msgEl = document.getElementById('toast-message');
                msgEl.textContent = message;
                toastEl.classList.remove('hidden');
                setTimeout(() => {
                    toastEl.classList.add('hidden');
                }, 3000);
            },

            registerSW() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(reg => console.log('Service worker registered successfully', reg))
                            .catch(err => console.error('Service worker registration failed', err));
                    });
                }
            }
        };
        
        window.onload = () => {
            app.init();
        };
    </script>
</body>
</html>


